var Penpal=function(){"use strict";var e="handshake";var r="handshake-reply";var n="call";var a="reply";var t="fulfilled";var o="rejected";var i="message";var c="DataCloneError";var d="ConnectionDestroyed";var v="ConnectionTimeout";var u="NotInIframe";var s="NoIframeSrc";var f=function(){var e=[];var r=false;return{destroy:function n(){r=true;e.forEach(function(e){e()})},onDestroy:function n(a){r?a():e.push(a)}}};var l={"http:":"80","https:":"443"};var m=/^(https?:)?\/\/([^\/:]+)?(:(\d+))?/;var h=["file:","data:"];var g=function(e){if(e&&h.find(function(r){return e.startsWith(r)})){return"null"}var r=document.location;var n=m.exec(e);var a;var t;var o;if(n){a=n[1]?n[1]:r.protocol;t=n[2];o=n[4]}else{a=r.protocol;t=r.hostname;o=r.port}var i=o&&o!==l[a]?":".concat(o):"";return"".concat(a,"//").concat(t).concat(i)};var p=function(e){return function(){if(e){var r;for(var n=arguments.length,a=new Array(n),t=0;t<n;t++){a[t]=arguments[t]}(r=console).log.apply(r,["[Penpal]"].concat(a))}}};var E=function e(r){var n=r.name,a=r.message,t=r.stack;return{name:n,message:a,stack:t}};var w=function e(r){var n=new Error;Object.keys(r).forEach(function(e){return n[e]=r[e]});return n};var y=function(e,r,d){var v=e.localName,u=e.local,s=e.remote,f=e.originForSending,l=e.originForReceiving;var m=false;d("".concat(v,": Connecting call receiver"));var h=function e(i){if(i.source!==s||i.data.penpal!==n){return}if(i.origin!==l){d("".concat(v," received message from origin ").concat(i.origin," which did not match expected origin ").concat(l));return}var u=i.data,h=u.methodName,g=u.args,p=u.id;d("".concat(v,": Received ").concat(h,"() call"));var w=function e(r){return function(e){d("".concat(v,": Sending ").concat(h,"() reply"));if(m){d("".concat(v,": Unable to send ").concat(h,"() reply due to destroyed connection"));return}var n={penpal:a,id:p,resolution:r,returnValue:e};if(r===o&&e instanceof Error){n.returnValue=E(e);n.returnValueIsError=true}try{s.postMessage(n,f)}catch(e){if(e.name===c){s.postMessage({penpal:a,id:p,resolution:o,returnValue:E(e),returnValueIsError:true},f)}throw e}}};new Promise(function(e){return e(r[h].apply(r,g))}).then(w(t),w(o))};u.addEventListener(i,h);return function(){m=true;u.removeEventListener(i,h)}};var N=0;var C=function(){return++N};var I=function(e,r,o,c,v){var u=r.localName,s=r.local,f=r.remote,l=r.originForSending,m=r.originForReceiving;var h=false;v("".concat(u,": Connecting call sender"));var g=function e(r){return function(){for(var e=arguments.length,o=new Array(e),g=0;g<e;g++){o[g]=arguments[g]}v("".concat(u,": Sending ").concat(r,"() call"));var p;try{if(f.closed){p=true}}catch(e){p=true}if(p){c()}if(h){var E=new Error("Unable to send ".concat(r,"() call due ")+"to destroyed connection");E.code=d;throw E}return new Promise(function(e,c){var d=C();var h=function n(o){if(o.source!==f||o.data.penpal!==a||o.data.id!==d){return}if(o.origin!==m){v("".concat(u," received message from origin ").concat(o.origin," which did not match expected origin ").concat(m));return}v("".concat(u,": Received ").concat(r,"() reply"));s.removeEventListener(i,n);var l=o.data.returnValue;if(o.data.returnValueIsError){l=w(l)}(o.data.resolution===t?e:c)(l)};s.addEventListener(i,h);f.postMessage({penpal:n,id:d,methodName:r,args:o},l)})}};o.reduce(function(e,r){e[r]=g(r);return e},e);return function(){h=true}};var T=6e4;var k=function(n){var a=n.iframe,t=n.methods,o=t===void 0?{}:t,c=n.childOrigin,u=n.timeout,l=n.debug;var m=p(l);var h=window;var E=f(),w=E.destroy,N=E.onDestroy;if(!c){if(!a.src&&!a.srcdoc){var C=new Error("Iframe must have src or srcdoc property defined.");C.code=s;throw C}c=g(a.src)}var k=c==="null"?"*":c;var O=new Promise(function(n,t){var s;if(u!==undefined){s=setTimeout(function(){var e=new Error("Connection to child timed out after ".concat(u,"ms"));e.code=v;t(e);w()},u)}var f={};var l;var g;var p=function t(i){var d=a.contentWindow;if(i.source!==d||i.data.penpal!==e){return}if(i.origin!==c){m("Parent received handshake from origin ".concat(i.origin," which did not match expected origin ").concat(c));return}m("Parent: Received handshake, sending reply");i.source.postMessage({penpal:r,methodNames:Object.keys(o)},k);var v={localName:"Parent",local:h,remote:d,originForSending:k,originForReceiving:c};if(g){g()}g=y(v,o,m);N(g);if(l){l.forEach(function(e){delete f[e]})}l=i.data.methodNames;var u=I(f,v,l,w,m);N(u);clearTimeout(s);n(f)};h.addEventListener(i,p);m("Parent: Awaiting handshake");var E=setInterval(function(){if(!document.body.contains(a)){clearInterval(E);w()}},T);N(function(){h.removeEventListener(i,p);clearInterval(E);var e=new Error("Connection destroyed");e.code=d;t(e)})});return{promise:O,destroy:w}};var O=function(){var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},a=n.parentOrigin,t=a===void 0?"*":a,o=n.methods,c=o===void 0?{}:o,s=n.timeout,l=n.debug;var m=p(l);if(window===window.top){var h=new Error("connectToParent() must be called within an iframe");h.code=u;throw h}var g=f(),E=g.destroy,w=g.onDestroy;var N=window;var C=N.parent;var T=new Promise(function(n,a){var o;if(s!==undefined){o=setTimeout(function(){var e=new Error("Connection to parent timed out after ".concat(s,"ms"));e.code=v;a(e);E()},s)}var u=function e(a){try{clearTimeout("")}catch(e){return}if(a.source!==C||a.data.penpal!==r){return}if(t!=="*"&&t!==a.origin){m("Child received handshake reply from origin ".concat(a.origin," which did not match expected origin ").concat(t));return}m("Child: Received handshake reply");N.removeEventListener(i,e);var d={localName:"Child",local:N,remote:C,originForSending:a.origin==="null"?"*":a.origin,originForReceiving:a.origin};var v={};var u=y(d,c,m);w(u);var s=I(v,d,a.data.methodNames,E,m);w(s);clearTimeout(o);n(v)};N.addEventListener(i,u);w(function(){N.removeEventListener(i,u);var e=new Error("Connection destroyed");e.code=d;a(e)});m("Child: Sending handshake");C.postMessage({penpal:e,methodNames:Object.keys(c)},t)});return{promise:T,destroy:E}};var P={ERR_CONNECTION_DESTROYED:d,ERR_CONNECTION_TIMEOUT:v,ERR_NOT_IN_IFRAME:u,ERR_NO_IFRAME_SRC:s,connectToChild:k,connectToParent:O};return P}();